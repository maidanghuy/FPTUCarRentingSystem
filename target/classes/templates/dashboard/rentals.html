<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <title>Rentals Dashboard - FUCarRenting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .admin-sidebar {
            min-height: 100vh;
            background-color: #343a40;
            color: white;
        }

        .admin-sidebar a {
            color: white;
            display: block;
            padding: 12px 20px;
            text-decoration: none;
        }

        .admin-sidebar a:hover {
            background-color: #495057;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Admin - FUCarRenting</a>
            <button class="btn btn-outline-light" id="logout">Logout</button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 admin-sidebar">
                <h5 class="p-3">Management</h5>
                <a href="cars">Manage Cars</a>
                <a href="customers">Manage Customers</a>
                <a href="rentals">Manage Rentals</a>
                <a href="producers">Manage Producers</a>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <h2>Rental Management</h2>

                <!-- Date Filter -->
                <form class="row g-3 mb-3" id="filterForm">
                    <div class="col-md-4">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="col-md-4">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Filter Rentals</button>
                    </div>
                </form>

                <!-- Rentals Table -->
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Rental ID</th>
                            <th>Car Name</th>
                            <th>Customer Name</th>
                            <th>Pickup Date</th>
                            <th>Return Date</th>
                            <th>Rent Price ($)</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rentalTableBody">
                    </tbody>
                </table>
                <!-- Pagination -->
                <nav>
                    <ul class="pagination justify-content-center" id="paginationNav">
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        let currentPage = 0;
        let pageSize = 5;
        let lastStartDate = '';
        let lastEndDate = '';

        function fetchRentals(page = 0, size = 10, startDate = '', endDate = '') {
            const token = localStorage.getItem("accessToken");
            if (!startDate) startDate = document.getElementById("startDate").value;
            if (!endDate) endDate = document.getElementById("endDate").value;
            lastStartDate = startDate;
            lastEndDate = endDate;
            currentPage = page;
            pageSize = size;

            fetch(`/de180293/api/dashboard/rentals/report?startDate=${startDate}&endDate=${endDate}&page=${page}&size=${size}`, {
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
                .then(res => res.json())
                .then(data => {
                    const pageData = data.result || {};
                    const rentals = pageData.content || [];
                    const tbody = document.getElementById("rentalTableBody");
                    tbody.innerHTML = "";

                    if (rentals.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No rentals found.</td></tr>`;
                    } else {
                        rentals.forEach(rental => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                          <td>${rental.rentalId}</td>
                                          <td>${rental.carName}</td>
                                          <td>${rental.customerName}</td>
                                          <td>${rental.pickupDate.replace("T", " ")}</td>
                                          <td>${rental.returnDate.replace("T", " ")}</td>
                                          <td>${rental.rentPrice}</td>
                                          <td>
                                            <span class="badge ${rental.status === 'ONGOING' ? 'bg-info' :
                                    rental.status === 'COMPLETED' ? 'bg-success' :
                                        rental.status === 'CANCELLED' ? 'bg-danger' :
                                            'bg-secondary'}">
                                              ${rental.status}
                                            </span>
                                          </td>
                                          <td>
                                            ${(rental.status === 'DEPOSITED' || rental.status === 'CONFIRMED') ?
                                    `<button class="btn btn-success btn-sm" onclick="markRented('${rental.rentalId}')">Đã gửi xe</button>` : ''}
                                          </td>
                                        `;
                            tbody.appendChild(row);
                        });
                    }
                    renderPagination(pageData);
                })
                .catch(err => {
                    console.error("Error fetching rentals:", err);
                    document.getElementById("rentalTableBody").innerHTML =
                        `<tr><td colspan="7" class="text-center text-danger">Failed to load data.</td></tr>`;
                    document.getElementById("paginationNav").innerHTML = '';
                });
        }

        async function markRented(rentalId) {
            if (!confirm('Xác nhận đã gửi xe cho khách?')) return;
            const token = localStorage.getItem("accessToken");
            try {
                await fetch(`/de180293/api/dashboard/rentals/${rentalId}/mark-rented`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                fetchRentals(currentPage, pageSize, lastStartDate, lastEndDate);
            } catch (err) {
                alert('Cập nhật trạng thái thất bại!');
            }
        }

        function renderPagination(pageData) {
            const nav = document.getElementById("paginationNav");
            nav.innerHTML = '';
            if (!pageData || pageData.totalPages <= 1) return;
            const totalPages = pageData.totalPages;
            const current = pageData.number;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item' + (current === 0 ? ' disabled' : '');
            prevLi.innerHTML = `<a class="page-link" href="#" tabindex="-1">Previous</a>`;
            prevLi.onclick = function (e) { e.preventDefault(); if (current > 0) fetchRentals(current - 1, pageSize, lastStartDate, lastEndDate); };
            nav.appendChild(prevLi);

            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === current ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="#">${i + 1}</a>`;
                li.onclick = function (e) { e.preventDefault(); if (i !== current) fetchRentals(i, pageSize, lastStartDate, lastEndDate); };
                nav.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item' + (current === totalPages - 1 ? ' disabled' : '');
            nextLi.innerHTML = `<a class="page-link" href="#">Next</a>`;
            nextLi.onclick = function (e) { e.preventDefault(); if (current < totalPages - 1) fetchRentals(current + 1, pageSize, lastStartDate, lastEndDate); };
            nav.appendChild(nextLi);
        }

        document.getElementById("filterForm").addEventListener("submit", function (e) {
            e.preventDefault();
            fetchRentals(0, pageSize);
        });

        // Optionally, load today's rentals by default
        window.onload = function () {
            fetchRentals(0, pageSize, '', '');
        };
    </script>

    <!-- Logout Script -->
    <script>
        document.getElementById('logout').addEventListener('click', function (e) {
            e.preventDefault();
            localStorage.removeItem("accessToken");
            localStorage.removeItem("username");
            localStorage.removeItem("role");

            fetch('http://localhost:8080/de180293/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            })
                .then(() => window.location.href = "../auth/login");
        });
    </script>

</body>

</html>