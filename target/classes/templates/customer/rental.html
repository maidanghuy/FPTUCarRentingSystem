<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <meta charset="UTF-8">
  <title>Rentals - FUCarRentingSystem</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">FUCarRenting</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="../home">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="rental">Rental</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="profile">Profile</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-danger" href="#" id="logout">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Rental content -->
  <div class="container mt-4">
    <h2 class="mb-4">My Rental Transactions</h2>
    <div id="rentalList" class="row row-cols-1 row-cols-md-2 g-4"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("accessToken");

      try {
        const res = await axios.get("/de180293/api/customer/rentals", {
          headers: { Authorization: `Bearer ${token}` }
        });

        const rentalList = document.getElementById("rentalList");
        if (res.data && Array.isArray(res.data.result)) {
          res.data.result.forEach(rental => {
            const card = document.createElement("div");
            card.className = "col";
            card.innerHTML = `
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h5 class="card-title">${rental.car.carName}</h5>
                                <p class="card-text mb-1"><strong>Price:</strong> $${rental.rentPrice}</p>
                                <p class="card-text mb-1"><strong>Pickup:</strong> ${rental.pickupDate}</p>
                                <p class="card-text mb-1"><strong>Return:</strong> ${rental.returnDate}</p>
                                <p class="card-text"><strong>Status:</strong> ${rental.status}</p>
                                ${rental.status === 'PENDING' ? `
  <button class='btn btn-danger btn-sm mt-2' onclick='cancelRental("${rental.rentalId}")'>Huỷ</button>
  <button class='btn btn-warning btn-sm mt-2 ms-2' onclick='depositRental("${rental.rentalId}")'>Đặt cọc</button>
` : ''}
                            </div>
                        </div>
                    `;
            rentalList.appendChild(card);
          });
        } else {
          rentalList.innerHTML = `<p>No rental history found.</p>`;
        }
      } catch (error) {
        console.error(error);
        document.getElementById("rentalList").innerHTML = `<p class="text-danger">Failed to load rental data.</p>`;
      }
    });
  </script>
  <script>
    async function cancelRental(rentalId) {
      if (!confirm('Bạn có chắc muốn huỷ đơn thuê này?')) return;
      const token = localStorage.getItem("accessToken");
      try {
        await axios.delete(`/de180293/api/customer/rentals/${rentalId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        // Reload rentals after cancel
        location.reload();
      } catch (error) {
        alert('Huỷ đơn thuê thất bại!');
      }
    }
  </script>

  <script>
    async function depositRental(rentalId) {
      if (!confirm('Bạn có chắc muốn đặt cọc cho đơn thuê này?')) return;
      const token = localStorage.getItem("accessToken");
      try {
        await axios.put(`/de180293/api/customer/rentals/${rentalId}/deposit`, {}, {
          headers: { Authorization: `Bearer ${token}` }
        });
        location.reload();
      } catch (error) {
        alert('Đặt cọc thất bại!');
      }
    }
  </script>

  <!-- LOGOUT -->
  <script>
    document.getElementById('logout').addEventListener('click', function (e) {
      e.preventDefault();

      // Xoá JWT token trong localStorage
      localStorage.removeItem("accessToken");
      localStorage.removeItem("username");
      localStorage.removeItem("role");

      fetch('http://localhost:8080/de180293/api/auth/logout', {
        method: 'POST',
        credentials: 'include' // để gửi cookie theo request
      })
        .then(res => res.json())
        .then(data => {
          console.log(data.message);
        });
      // Chuyển hướng về trang login
      window.location.href = "../auth/login";
    });
  </script>
</body>

</html>